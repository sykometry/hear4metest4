<!DOCTYPE html>
<html lang="en">
  <!-- trigger build -->
<head>
  <link rel="stylesheet" href="style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
<div class="header">
  <h1>Hear4Me</h1>
</div>
</head>
<body>
<div class="body">
  <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Sound Detector (dB Threshold)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      text-align: center;
      padding: 2em;
      background-color: #f0f0f0;
    }
    canvas {
      border: 1px solid #ccc;
      display: block;
      margin: 1em auto;
      background-color: #fff;
    }
    #controls {
      margin-bottom: 1em;
    }
    input[type="number"] {
      width: 60px;
    }
    ul {
      list-style-type: none;
      padding: 0;
    }
    li {
      background: #fff;
      margin: 5px auto;
      padding: 8px 12px;
      width: 80%;
      border-radius: 4px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
  </style>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.16.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/speech-commands@0.5.3"></script>

</head>
<body>

 <h2>Sound Detector</h2>

  <button id="enableNotifBtn">Enable Notifications</button>
  <button id="startBtn">Start Listening</button>
  <p id="status">Click "Start Listening" to begin.</p>

  <div id="controls">
    <label for="dbThreshold">dB Threshold:</label>
    <input type="number" id="dbThreshold" value="-40" min="-100" max="0" step="1" /> dB
  </div>

  <canvas id="visualizer" width="600" height="100"></canvas>

  <div id="logContainer">
    <h3>Detection Log</h3>
    <ul id="eventLog"></ul>
  </div>
<script>
  if (!window.name) {
    window.name = `tab-${Date.now()}-${Math.random().toString(36).substring(2, 8)}`;
  }

  const startBtn = document.getElementById("startBtn");
  const enableNotifBtn = document.getElementById("enableNotifBtn");
  const statusEl = document.getElementById("status");
  const dbThresholdInput = document.getElementById("dbThreshold");
  const canvas = document.getElementById("visualizer");
  const canvasCtx = canvas.getContext("2d");
  const eventLog = document.getElementById("eventLog");

  let dbThreshold = parseFloat(dbThresholdInput.value);
  let logCount = 0;
  let lastLogTime = 0;
  let listening = false;
let audioContext = null;
let microphoneStream = null;
let animationId = null;

  const logCooldown = 3000; // 3 seconds between logs

  dbThresholdInput.addEventListener("input", () => {
    dbThreshold = parseFloat(dbThresholdInput.value);
  });

  enableNotifBtn.addEventListener("click", async () => {
    if (!("Notification" in window)) {
      alert("Notifications are not supported.");
      return;
    }

    const permission = await Notification.requestPermission();
    if (permission === "granted") {
      new Notification("ðŸ”” Notifications enabled!", {
        body: "Youâ€™ll now receive sound alerts."
      });
      enableNotifBtn.disabled = true;
    } else {
      alert("Notification permission denied.");
    }
  });

  const broadcast = new BroadcastChannel("sound_detector_channel");

  broadcast.onmessage = (event) => {
    const { type, volume, timestamp, origin, noiseType } = event.data;
    if (type === "sound-detected" && origin !== window.name) {
      const msg = `ðŸ”Š Sound detected from another tab! Volume: ${volume.toFixed(1)} dB, Type: ${noiseType}`;
      logEvent(msg);
    }
  };

  function zeroCrossingRate(dataArray) {
  let zeroCrossings = 0;
  for (let i = 1; i < dataArray.length; i++) {
    if ((dataArray[i - 1] - 128) * (dataArray[i] - 128) < 0) {
      zeroCrossings++;
    }
  }
  return zeroCrossings / dataArray.length;
}

function classifyNoise(db, dataArray) {
  if (db < dbThreshold) return "Silence";

  let mean = 0;
  for (let i = 0; i < dataArray.length; i++) {
    mean += dataArray[i];
  }
  mean /= dataArray.length;

  let variance = 0;
  for (let i = 0; i < dataArray.length; i++) {
    variance += (dataArray[i] - mean) ** 2;
  }
  variance /= dataArray.length;

  const zcr = zeroCrossingRate(dataArray);

  if (db > -20) {
    return "Alarm";
  }
  if (db > -30 ) {
    return "Horn";
  
  }  if (db > -37) {
    return "Baby Crying";
  }
  if (db > -45) {
    return "Voice";
  }

  if (variance <= 500) {
    return "Background Noise";
  }

  return "Unknown Noise";
}


  function logEvent(message) {
    const now = new Date();
    const timeStr = now.toLocaleTimeString();
    const timestamp = now.getTime();

    if (timestamp - lastLogTime < logCooldown) return;

    const li = document.createElement('li');
    li.textContent = `[${timeStr}] ${message}`;
    eventLog.prepend(li);

    logCount++;
    lastLogTime = timestamp;

    if (logCount >= 10) {
      setTimeout(() => {
        eventLog.innerHTML = '';
        logCount = 0;
      }, 300);
    }

    if (Notification.permission === 'granted') {
      new Notification("ðŸ”Š Sound Detected", {
        body: message,
        icon: "https://icons.iconarchive.com/icons/google/noto-emoji-objects/64/62841-loudspeaker-icon.png"
      });
    }
  }

 startBtn.addEventListener("click", async () => {


  if (listening) {
    listening = false;

    if (animationId) cancelAnimationFrame(animationId);
    if (microphoneStream) {
      microphoneStream.getTracks().forEach(track => track.stop());
    }
    if (audioContext) {
      audioContext.close();
    }

    startBtn.textContent = "Start Listening";
    statusEl.textContent = "Listening stopped.";
    return;
  }

 
  try {
    microphoneStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    audioContext = new AudioContext();

    if (audioContext.state === "suspended") {
      await audioContext.resume();
    }

    const source = audioContext.createMediaStreamSource(microphoneStream);
    const analyser = audioContext.createAnalyser();
    analyser.fftSize = 512;
    const timeData = new Uint8Array(analyser.fftSize);

    source.connect(analyser);

    listening = true;
    startBtn.textContent = "Stop Listening";
    statusEl.textContent = "Listening... make some noise!";

    function detectSound() {
      if (!listening) return;

      analyser.getByteTimeDomainData(timeData);

      let rms = 0;
      for (let i = 0; i < timeData.length; i++) {
        let val = (timeData[i] - 128) / 128.0;
        rms += val * val;
      }
      rms = Math.sqrt(rms / timeData.length);
      let db = 20 * Math.log10(rms || 0.000001);

      const noiseType = classifyNoise(db, timeData);

      if (db > dbThreshold && noiseType !== "Silence") {
        const msg = `Sound detected! Volume: ${db.toFixed(1)} dB, Type: ${noiseType}`;
        statusEl.textContent = msg;
        logEvent(msg);

        broadcast.postMessage({
          type: "sound-detected",
          volume: db,
          noiseType,
          timestamp: Date.now(),
          origin: window.name
        });
      } else {
        statusEl.textContent = `Listening... quiet (${db.toFixed(1)} dB)`;
      }

      drawWaveform(timeData);
      animationId = requestAnimationFrame(detectSound);
    }

    detectSound();

  } catch (err) {
    console.error("Microphone access error:", err);
    statusEl.textContent = "Microphone access denied or not available.";
  }
});


      const source = audioContext.createMediaStreamSource(stream);

      const analyser = audioContext.createAnalyser();
      analyser.fftSize = 512;
      const timeData = new Uint8Array(analyser.fftSize);

      source.connect(analyser);

      statusEl.textContent = "Listening... make some noise!";

      function detectSound() {
        if (!listening) return;

        analyser.getByteTimeDomainData(timeData);

        // Compute RMS volume from timeData
        let rms = 0;
        for (let i = 0; i < timeData.length; i++) {
          let val = (timeData[i] - 128) / 128.0;
          rms += val * val;
        }
        rms = Math.sqrt(rms / timeData.length);
        let db = 20 * Math.log10(rms || 0.000001);

        // Classify noise type
        const noiseType = classifyNoise(db, timeData);

        if (db > dbThreshold && noiseType !== "Silence") {
          const msg = `Sound detected! Volume: ${db.toFixed(1)} dB, Type: ${noiseType}`;
          statusEl.textContent = msg;
          logEvent(msg);

          broadcast.postMessage({
            type: "sound-detected",
            volume: db,
            noiseType,
            timestamp: Date.now(),
            origin: window.name
          });
        } else {
          statusEl.textContent = `Listening... quiet (${db.toFixed(1)} dB)`;
        }

        drawWaveform(timeData);

        requestAnimationFrame(detectSound);
      }

      function drawWaveform(data) {
        canvasCtx.clearRect(0, 0, canvas.width, canvas.height);
        canvasCtx.lineWidth = 2;
        canvasCtx.strokeStyle = "#007acc";
        canvasCtx.beginPath();

        let sliceWidth = canvas.width / data.length;
        let x = 0;

        for (let i = 0; i < data.length; i++) {
          let v = data[i] / 128.0;
          let y = v * canvas.height / 2;

          if (i === 0) {
            canvasCtx.moveTo(x, y);
          } else {
            canvasCtx.lineTo(x, y);
          }
          x += sliceWidth;
        }

        canvasCtx.lineTo(canvas.width, canvas.height / 2);
        canvasCtx.stroke();
      }

      detectSound();


</script>
</body>
</html>

</div>

</body>

</html>
